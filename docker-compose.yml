version: "3.9"
services:
  backend:
    container_name: uli_nodejs
    restart: always
    build:
      context: .
    ports:
    - "80:3000"
    - "5678:5678"
    - "9229:9229"
    environment:
    - ES_HOST=elasticsearch
    - NODE_ENV=development
    - SERVER_HOST=192.168.1.74
    command: yarn dev
    volumes:
    - .:/usr/src/app/
    - ./error.log:/usr/src/app/error.log
    - /usr/src/app/node_modules/
    depends_on:
    - elasticsearch
  elasticsearch:
      container_name: uli_elasticsearch
      image: docker.elastic.co/elasticsearch/elasticsearch:7.10.1
      environment:
      - node.name=uli-es01
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - ELASTIC_PASSWORD=$ELASTIC_PASSWORD
      - xpack.license.self_generated.type=trial 
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=$CERTS_DIR/es01/es01.key
      - xpack.security.http.ssl.certificate_authorities=$CERTS_DIR/ca/ca.crt
      - xpack.security.http.ssl.certificate=$CERTS_DIR/es01/es01.crt
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.verification_mode=certificate 
      - xpack.security.transport.ssl.certificate_authorities=$CERTS_DIR/ca/ca.crt
      - xpack.security.transport.ssl.certificate=$CERTS_DIR/es01/es01.crt
      - xpack.security.transport.ssl.key=$CERTS_DIR/es01/es01.key      
      volumes:
      - ./certs:/usr/share/elasticsearch/config/certificates
      - ./docker-data-volumes/elasticsearch:/usr/share/elasticsearch/data
      - ./esbackup:/usr/share/elasticsearch/esbackup
      ports:
      - "9200:9200"
  kibana:
      container_name: uli_kibana
      depends_on:
      - elasticsearch  
      image: docker.elastic.co/kibana/kibana:7.10.1
      ports:
      - 5601:5601
      volumes:
      - ./kibana.yml:/usr/share/kibana/config/kibana.yml
      - ./certs:/etc/kibana/certs
volumes:
  esdata:
    driver: local
 